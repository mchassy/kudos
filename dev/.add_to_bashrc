export FLASK_APP=/prj/kudos/kudos_oss/app/http/api/endpoints.py
export APP_CONFIG_FILE=/prj/kudos/config/development.py
export FLASK_ENV=development
export LC_ALL=C.UTF-8
export LANG=C.UTF-8
export PATH="/home/ubuntu/.local/bin:$PATH"
echo "#######################################################"
if [[ -z "${CI_JOB_STAGE}" ]]
then
    CI_JOB_STAGE="locally"
    cd /prj && pwd
    echo "Running $CI_JOB_STAGE"
else
    cd /builds/mapu/kudos && pwd
    echo "Running $CI_JOB_STAGE on Gitlab runner"
fi
echo "#######################################################"
if [[ -d "./env/bin" && $CI_JOB_STAGE -eq "locally" ]]
then
    echo "#######################################################"
    echo "Activating virtual environment"
    echo "#######################################################"
    source ./env/bin/activate
elif [[ $CI_JOB_STAGE -eq "locally" || $CI_JOB_STAGE -eq "lint_code" ]]
then
    echo "#######################################################"
    echo "Creating virtual environment"
    echo "#######################################################"
    python -m venv env
    echo "#######################################################"
    echo "Activating virtual environment"
    echo "#######################################################"
    source ./env/bin/activate
    pip install -r ./dev/requirements.txt
elif [[ $CI_JOB_STAGE -eq "build_image" ]]
then
  echo "#######################################################"
  echo "Installing awscli"
  echo "#######################################################"
  sudo apt-get install awscli
else
  echo "#######################################################"
  echo "Nothing to do"
  echo "#######################################################"
fi
