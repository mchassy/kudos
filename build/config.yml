---
- name: kudos
  hosts: all
  vars:
    ansible_bender:
      base_image: "{{ lookup('env','DOCKER_URI') }}/alpine:latest"
      working_container:
        working_dir: /prj/kudos
        volumes:
          - '{{ playbook_dir }}:/src'

      target_image:
        name: kudos-prod
        entrypoint: ["dumb-init", "/bin/sh", "-c", "python3", "-m", "flask", "run", "--port", "4433", "&", ]
        labels:
          built-by: '{{ ansible_user }}'
  environment:
    FLASK_APP: /prj/kudos/kudos_oss/app/http/api/endpoints.py
    APP_CONFIG_FILE: /prj/kudos/config/development.py
    FLASK_ENV: development
  tasks:
  - name: Install additional packages
    apk:
      name: curl dumb-init
  # This way of upgrading pip should cause an error on ansible-lint
  # - name: upgrade pip
  #   command: 'pip3 install --upgrade pip'
  # This way of upgrading pip should pass ansible-lint
  - name: Install dumb init
    get_url:
      dest: /usr/bin/dumb-init
      url: https://github.com/Yelp/dumb-init/releases/download/v1.0.2/dumb-init_1.0.2_amd64
      mode: 0775
      validate_certs: no
  - name: install the latest version of pip
    pip:
      name: pip
      extra_args: --upgrade
  - name: create /kudos directory
    file: name=/kudos state=directory mode=0775
  - name: copy in pip requirements
    template: src=../dev/requirements.txt dest=/kudos/requirements.txt mode=0775
  - name: install pip requirments
    pip:
      requirements: /kudos/requirements.txt
  - name: create config directory
    copy: src=../config dest=/kudos mode=0775
  - name: create code directory
    copy: src=../kudos_oss dest=/kudos mode=0775
...
